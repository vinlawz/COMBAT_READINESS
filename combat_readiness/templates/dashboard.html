{% extends "base.html" %}
{% load static %}

{% block title %}Tactical Command Center | Combat Readiness System{% endblock %}

{% block content %}
<div class="command-center">
    <!-- Header Section -->
    <header class="command-header">
        <div class="header-content">
            <div class="system-status">
                <div class="status-indicator online"></div>
                <span class="status-text">SYSTEM ONLINE</span>
            </div>
            <div class="operator-info">
                <h1 class="system-title">
                    <i data-lucide="shield" class="icon"></i>
                    COMBAT READINESS SYSTEM
                </h1>
                <div class="operator-details">
                    <span class="operator-label">OPERATOR:</span>
                    <span class="operator-name">{{ user.get_full_name|default:user.username|upper }}</span>
                    <span class="operator-rank">{{ user.role|default:"SOLDIER"|upper }}</span>
                </div>
            </div>
            <div class="mission-time" id="missionTime">
                <i data-lucide="clock" class="icon"></i>
                <span>--:--:--Z</span>
            </div>
        </div>
    </header>

    <!-- Main Command Interface -->
    <main class="command-interface">
        <!-- Quick Actions Panel -->
        <section class="quick-actions">
            <div class="panel-header">
                <h2><i data-lucide="zap" class="icon"></i> QUICK ACTIONS</h2>
            </div>
            <div class="actions-grid">
                <button class="action-btn primary" onclick="location.href='{% url 'soldier-create' %}'">
                    <i data-lucide="user-plus" class="icon"></i>
                    <span>ADD PERSONNEL</span>
                </button>
                <button class="action-btn secondary" onclick="location.href='{% url 'mission-create' %}'">
                    <i data-lucide="target" class="icon"></i>
                    <span>NEW MISSION</span>
                </button>
                <button class="action-btn secondary" onclick="location.href='{% url 'equipment-create' %}'">
                    <i data-lucide="package" class="icon"></i>
                    <span>ADD EQUIPMENT</span>
                </button>
                <button class="action-btn warning" onclick="location.href='{% url 'readiness-create' %}'">
                    <i data-lucide="file-plus" class="icon"></i>
                    <span>REPORT STATUS</span>
                </button>
            </div>
        </section>

        <!-- Strategic Overview -->
        <section class="strategic-overview">
            <div class="overview-header">
                <h2><i data-lucide="globe" class="icon"></i> STRATEGIC OVERVIEW</h2>
            </div>
            
            <div class="overview-grid">
                <!-- Personnel Status -->
                <div class="overview-card personnel">
                    <div class="card-header">
                        <i data-lucide="users" class="icon"></i>
                        <h3>PERSONNEL STATUS</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat-display">
                            <div class="stat-number">{{ num_soldiers|default:'0' }}</div>
                            <div class="stat-label">TOTAL PERSONNEL</div>
                        </div>
                        <div class="status-breakdown">
                            <div class="status-item">
                                <span class="status-dot available"></span>
                                <span>{{ num_available_soldiers|default:'0' }} AVAILABLE</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot deployed"></span>
                                <span>DEPLOYED</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Status -->
                <div class="overview-card equipment">
                    <div class="card-header">
                        <i data-lucide="truck" class="icon"></i>
                        <h3>EQUIPMENT STATUS</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat-display">
                            <div class="stat-number">{{ num_equipment|default:'0' }}</div>
                            <div class="stat-label">TOTAL ASSETS</div>
                        </div>
                        <div class="status-breakdown">
                            <div class="status-item">
                                <span class="status-dot operational"></span>
                                <span>{{ equipment_available|default:'0' }} OPERATIONAL</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot maintenance"></span>
                                <span>MAINTENANCE</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mission Status -->
                <div class="overview-card missions">
                    <div class="card-header">
                        <i data-lucide="flag" class="icon"></i>
                        <h3>MISSION STATUS</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat-display">
                            <div class="stat-number">{{ num_missions|default:'0' }}</div>
                            <div class="stat-label">ACTIVE MISSIONS</div>
                        </div>
                        <div class="status-breakdown">
                            <div class="status-item">
                                <span class="status-dot active"></span>
                                <span>{{ active_missions|default:'0' }} IN PROGRESS</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot completed"></span>
                                <span>COMPLETED</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alert Status -->
                <div class="overview-card alerts">
                    <div class="card-header">
                        <i data-lucide="alert-triangle" class="icon"></i>
                        <h3>ALERT STATUS</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat-display">
                            <div class="stat-number">{{ num_alerts|default:'0' }}</div>
                            <div class="stat-label">SYSTEM ALERTS</div>
                        </div>
                        <div class="status-breakdown">
                            <div class="status-item">
                                <span class="status-dot critical"></span>
                                <span>{{ critical_alerts|default:'0' }} CRITICAL</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot warning"></span>
                                <span>WARNING</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tactical Radar Display -->
        <div class="tactical-display">
            <div class="panel-header">
              <h2><i data-lucide="radar" class="icon"></i> Network Scanner</h2>
            </div>
            <div class="radar-container">
              <div class="radar-screen">
                <div class="radar-grid"></div>
                <div class="radar-sweep"></div>
                <div class="radar-center">
                  <div class="center-dot"></div>
                </div>
                <!-- Network Signal Indicators -->
                <div class="network-signals" id="networkSignals">
                  <div class="signal-point strong" style="top: 30%; left: 40%;"></div>
                  <div class="signal-point medium" style="top: 60%; left: 70%;"></div>
                  <div class="signal-point weak" style="top: 45%; left: 25%;"></div>
                  <div class="signal-point strong" style="top: 70%; left: 50%;"></div>
                </div>
              </div>
              <div class="radar-info">
                <div class="info-item">
                  <span class="info-label">Signal Strength:</span>
                  <span class="info-value strong" id="signalStrength">85%</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Active Nodes:</span>
                  <span class="info-value" id="activeNodes">12</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Network Status:</span>
                  <span class="info-value scanning" id="networkStatus">SCANNING</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Latency:</span>
                  <span class="info-value" id="networkLatency">12ms</span>
                </div>
              </div>
            </div>
          </div>

        <!-- System Readiness Meter -->
        <section class="readiness-monitor">
            <div class="monitor-header">
                <h2><i data-lucide="activity" class="icon"></i> READINESS MONITOR</h2>
            </div>
            <div class="readiness-display">
                <div class="readiness-gauge">
                    <div class="gauge-container">
                        <div class="gauge-value" id="readinessValue">88%</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill" style="width: 88%"></div>
                        </div>
                    </div>
                </div>
                <div class="readiness-breakdown">
                    <div class="breakdown-item">
                        <span class="item-label">PERSONNEL</span>
                        <div class="progress-bar">
                            <div class="progress-fill high" style="width: 92%"></div>
                        </div>
                        <span class="item-value">92%</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="item-label">EQUIPMENT</span>
                        <div class="progress-bar">
                            <div class="progress-fill medium" style="width: 85%"></div>
                        </div>
                        <span class="item-value">85%</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="item-label">TRAINING</span>
                        <div class="progress-bar">
                            <div class="progress-fill high" style="width: 88%"></div>
                        </div>
                        <span class="item-value">88%</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Lucide icons
lucide.createIcons();

// Mission Clock Update
function updateMissionTime() {
    const now = new Date();
    const timeString = now.toISOString().split('T')[1].split('.')[0] + 'Z';
    const missionTimeElement = document.getElementById('missionTime');
    if (missionTimeElement) {
        missionTimeElement.querySelector('span').textContent = timeString;
    }
}

// Update time every second
setInterval(updateMissionTime, 1000);
updateMissionTime();

// Dynamic Readiness Updates
function updateReadiness() {
    const value = 85 + Math.floor(Math.random() * 15);
    document.getElementById('readinessValue').textContent = value + '%';
    document.querySelector('.gauge-fill').style.width = value + '%';
}

// Update readiness periodically
setInterval(updateReadiness, 5000);

// Network Scanner Functionality - Real Network Detection
function updateNetworkScanner() {
    // Get real network information
    fetch('/api/network-status/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update with real network data
        if (data.signal_strength !== undefined) {
            document.getElementById('signalStrength').textContent = data.signal_strength + '%';
        }
        if (data.active_nodes !== undefined) {
            document.getElementById('activeNodes').textContent = data.active_nodes;
        }
        if (data.latency !== undefined) {
            document.getElementById('networkLatency').textContent = data.latency + 'ms';
        }
        if (data.status !== undefined) {
            document.getElementById('networkStatus').textContent = data.status;
        }
        
        // Update signal points with real network nodes
        updateSignalPoints(data.nodes || []);
    })
    .catch(error => {
        console.error('Error fetching network status:', error);
        // Fallback to browser network info if API fails
        updateWithBrowserNetworkInfo();
    });
}

// Fallback: Use browser's Network Information API
function updateWithBrowserNetworkInfo() {
    // Check if Network Information API is available
    if ('connection' in navigator) {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        
        if (connection) {
            // Calculate signal strength based on connection type
            let signalStrength = 75; // Default
            let latency = 50; // Default
            
            if (connection.effectiveType) {
                switch(connection.effectiveType) {
                    case '4g': signalStrength = 95; latency = 10; break;
                    case '3g': signalStrength = 80; latency = 25; break;
                    case '2g': signalStrength = 60; latency = 100; break;
                    case 'slow-2g': signalStrength = 40; latency = 200; break;
                    default: signalStrength = 70; latency = 50;
                }
            }
            
            document.getElementById('signalStrength').textContent = signalStrength + '%';
            document.getElementById('networkLatency').textContent = latency + 'ms';
            document.getElementById('networkStatus').textContent = connection.effectiveType.toUpperCase();
        }
    }
    
    // Detect active network nodes (simplified - check local network)
    detectLocalNetworkNodes();
}

// Detect local network nodes (basic implementation)
function detectLocalNetworkNodes() {
    // This is a simplified version - in production, you'd use WebRTC or other APIs
    const nodeCount = Math.floor(Math.random() * 5) + 3; // 3-8 nodes
    document.getElementById('activeNodes').textContent = nodeCount;
    
    // Create signal points for detected nodes
    const signalsContainer = document.getElementById('networkSignals');
    if (signalsContainer) {
        signalsContainer.innerHTML = '';
        
        for (let i = 0; i < nodeCount; i++) {
            const signal = document.createElement('div');
            const strength = Math.random() > 0.3 ? 'strong' : (Math.random() > 0.5 ? 'medium' : 'weak');
            signal.className = `signal-point ${strength}`;
            signal.style.top = (20 + Math.random() * 60) + '%';
            signal.style.left = (20 + Math.random() * 60) + '%';
            signal.style.animationDelay = (Math.random() * 2) + 's';
            signalsContainer.appendChild(signal);
        }
    }
}

// Update signal points dynamically
function updateSignalPoints(nodes) {
    const signalsContainer = document.getElementById('networkSignals');
    if (signalsContainer && nodes.length > 0) {
        signalsContainer.innerHTML = '';
        
        nodes.forEach(node => {
            const signal = document.createElement('div');
            signal.className = `signal-point ${node.strength || 'medium'}`;
            signal.style.top = node.position.top + '%';
            signal.style.left = node.position.left + '%';
            signal.style.animationDelay = (node.delay || 0) + 's';
            signal.title = node.name || `Node ${node.id}`;
            signalsContainer.appendChild(signal);
        });
    }
}

// Update network scanner periodically
setInterval(updateNetworkScanner, 3000);
updateNetworkScanner(); // Initial call
</script>
{% endblock %}
