{% extends "base.html" %}
{% load static %}

{% block title %}Edit Profile | Combat Readiness{% endblock %}

{% block extra_head %}
<style>
  .profile-container {
    background-color: #1a1e21;
    background-image: url('{% static "img/camo-bg.jpg" %}');
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
    border-radius: 18px;
    box-shadow: 0 0 32px rgba(35, 45, 35, 0.8), 0 0 8px rgba(58, 63, 45, 0.6);
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 profile-container">
  <!-- Live UTC Clock -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div></div>
    <div class="text-end text-light small mb-2" id="live-clock"></div>
  </div>
  <div class="row justify-content-center align-items-center" style="min-height:70vh;">
    <div class="col-md-8 col-lg-6">
      <div class="card bg-dark bg-opacity-75 shadow-lg text-white p-4">
        <h2 class="mb-4 text-center text-uppercase"><i class="fa-solid fa-user-pen me-2"></i>Edit Your Profile</h2>
        
        <!-- Profile Photo Section -->
        <div class="text-center mb-4">
          {% if user.profile.profile_image %}
            <img src="{{ user.profile.profile_image.url }}" alt="Profile Image" class="rounded-circle border border-3 border-warning shadow" style="width:150px;height:150px;object-fit:cover;">
          {% else %}
            <img src="{% static 'img/default-avatar.png' %}" alt="Default Profile" class="rounded-circle border border-3 border-warning shadow" style="width:150px;height:150px;object-fit:cover;">
          {% endif %}
        </div>

        <!-- Error Messages -->
        {% if user_form.errors or profile_form.errors %}
        <div class="alert alert-danger">
          <strong>Error:</strong> Please correct the errors below.
          {{ user_form.non_field_errors }}
          {{ profile_form.non_field_errors }}
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <!-- User Form Fields -->
          <div class="card mb-4 bg-dark bg-opacity-50 border border-secondary">
            <div class="card-header bg-dark bg-opacity-75">
              <h5 class="mb-0">Account Information</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="{{ user_form.first_name.id_for_label }}" class="form-label">First Name</label>
                {{ user_form.first_name }}
                {% if user_form.first_name.errors %}
                  <div class="invalid-feedback d-block">{{ user_form.first_name.errors }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.last_name.id_for_label }}" class="form-label">Last Name</label>
                {{ user_form.last_name }}
                {% if user_form.last_name.errors %}
                  <div class="invalid-feedback d-block">{{ user_form.last_name.errors }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.email.id_for_label }}" class="form-label">Email</label>
                {{ user_form.email }}
                {% if user_form.email.errors %}
                  <div class="invalid-feedback d-block">{{ user_form.email.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Profile Form Fields -->
          <div class="card mb-4 bg-dark bg-opacity-50 border border-secondary">
            <div class="card-header bg-dark bg-opacity-75">
              <h5 class="mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="{{ profile_form.profile_image.id_for_label }}" class="form-label">Profile Photo</label>
                <div class="input-group">
                  <span class="input-group-text bg-dark text-warning"><i class="fa-solid fa-image"></i></span>
                  {{ profile_form.profile_image }}
                </div>
                {% if profile_form.profile_image.errors %}
                  <div class="invalid-feedback d-block">{{ profile_form.profile_image.errors }}</div>
                {% endif %}
                <div class="form-text">Recommended size: 300x300 pixels. Max size: 2MB.</div>
              </div>
              <div class="mb-3">
                <label for="{{ profile_form.bio.id_for_label }}" class="form-label">Bio</label>
                {{ profile_form.bio }}
                {% if profile_form.bio.errors %}
                  <div class="invalid-feedback d-block">{{ profile_form.bio.errors }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                <label for="{{ profile_form.phone_number.id_for_label }}" class="form-label">Phone Number</label>
                <div class="input-group">
                  <span class="input-group-text bg-dark text-warning"><i class="fa-solid fa-phone"></i></span>
                  {{ profile_form.phone_number }}
                </div>
                {% if profile_form.phone_number.errors %}
                  <div class="invalid-feedback d-block">{{ profile_form.phone_number.errors }}</div>
                {% endif %}
              </div>
              <div class="form-check mb-3">
                {{ profile_form.receive_email_notifications }}
                <label for="{{ profile_form.receive_email_notifications.id_for_label }}" class="form-check-label">
                  Receive email notifications
                </label>
              </div>
              <div class="form-check mb-3">
                {{ profile_form.receive_sms_notifications }}
                <label for="{{ profile_form.receive_sms_notifications.id_for_label }}" class="form-check-label">
                  Receive SMS notifications (requires phone number)
                </label>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'profile' %}" class="btn btn-secondary me-md-2">
              <i class="fa-solid fa-arrow-left me-1"></i> Back to Profile
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-floppy-disk me-1"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Live clock
  function updateClock() {
    const now = new Date();
    document.getElementById('live-clock').textContent = now.toUTCString().replace('GMT', 'UTC');
  }
  setInterval(updateClock, 1000);
  updateClock();

  // Form validation
  (function() {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function(form) {
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>

<style>
  /* Custom styles for form elements */
  .form-control, .form-select, .form-control-file {
    background-color: #2c3034;
    border: 1px solid #444;
    color: #fff;
  }
  
  .form-control:focus, .form-select:focus, .form-control-file:focus {
    background-color: #2c3034;
    color: #fff;
    border-color: #ffc107;
    box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
  }
  
  .form-control:disabled, .form-control[readonly] {
    background-color: #2c3034;
    opacity: 0.7;
  }
  
  .form-text {
    color: #adb5bd !important;
  }
  
  .invalid-feedback {
    display: block;
    color: #dc3545;
  }
  
  .btn-primary {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
  }
  
  .btn-primary:hover {
    background-color: #e0a800;
    border-color: #d39e00;
    color: #000;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
  }
  
  .btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
  }
  
  .card {
    border: 1px solid rgba(255, 193, 7, 0.2);
  }
  
  .card-header {
    border-bottom: 1px solid rgba(255, 193, 7, 0.2);
  }
</style>
{% endblock %}
